<section class="lesson-page" *ngIf="currentLevel">
  <!-- Header -->
  <div class="lesson-header">
    <button class="btn-back" (click)="goBack()">
      {{ getBackButtonLabel() }}
    </button>
    <div class="lesson-title">
      <h1>{{ topic?.name || currentLevel.name }}</h1>
      <div class="level-badge">Level {{ currentLevel.level }}</div>
    </div>
    <p class="summary">{{ currentLevel.summary }}</p>
  </div>

  <!-- Video & Notes View -->
  <div class="lesson-content" *ngIf="viewState === 'video'">
    <!-- Video Section -->
    <div class="video-section">
      <h2>ğŸ“º Watch the Lesson</h2>
      <div class="video-container">
        <iframe
          *ngIf="safeVideoUrl"
          [src]="safeVideoUrl"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="notes-section">
      <h2>ğŸ“ Study Notes</h2>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           KAREL: Introduction to Python with Karel â€” rich notes
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <ng-container *ngIf="currentLevel.id === 'python-with-karel'">

        <!-- Hero Banner -->
        <div class="kn-banner">
          <div class="kn-banner-tag">Python Lesson 1</div>
          <h2>Introduction to Python with Karel</h2>
          <p>Meet your first robot â€” and write your very first Python program!</p>
        </div>

        <!-- 1 â€” Meet Karel -->
        <div class="kn-section kn-meet">
          <div class="kn-section-header">ğŸ• Meet Karel</div>
          <div class="kn-section-body">
            <div class="kn-callout kn-fun">
              <strong>Who is Karel?</strong> Karel is a friendly robot that lives inside a grid world.
              You are the programmer â€” you give Karel instructions and Karel follows them <em>exactly</em>.
              If you make a mistake, Karel gets confused! That's why we must write our code carefully.
            </div>
            <div class="kn-two-col">
              <div class="kn-col">
                <p>Karel's world is a <strong>grid of squares</strong>. Karel can:</p>
                <ul>
                  <li>Move forward one square</li>
                  <li>Turn left (90Â°)</li>
                  <li>Pick up and place balls</li>
                  <li>Follow functions you define</li>
                </ul>
                <p style="margin-top:0.6rem">
                  The <strong class="kn-hi">â–º</strong> symbol shows where Karel is and which direction it faces.
                  Karel always starts at the <strong>bottom-left</strong> corner facing <strong>East (right)</strong>.
                </p>
              </div>
              <div class="kn-col">
                <div class="kn-world-label">Start position</div>
                <table class="kn-world">
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td class="kn-karel">â–º</td><td></td><td></td><td></td><td></td><td></td></tr>
                </table>
                <p class="kn-legend">â–º Karel &nbsp;|&nbsp; â— Ball &nbsp;|&nbsp; â–  Wall</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 2 â€” Basic Commands -->
        <div class="kn-section kn-cmds">
          <div class="kn-section-header">ğŸ“‹ Karel's Basic Commands</div>
          <div class="kn-section-body">
            <div class="kn-callout kn-tip">
              <strong>Important rule:</strong> All commands must be written <em>exactly</em> right â€”
              correct spelling, brackets <code>()</code>, and no extra spaces.
              Python is case-sensitive: <code>Move()</code> is NOT the same as <code>move()</code>!
            </div>
            <table class="kn-cmd-table">
              <thead>
                <tr><th>Command</th><th>What it does</th><th>Think of it asâ€¦</th></tr>
              </thead>
              <tbody>
                <tr><td><code>move()</code></td><td>Karel moves one square forward</td><td>ğŸƒ Take one step</td></tr>
                <tr><td><code>turn_left()</code></td><td>Karel turns 90Â° to the left</td><td>â†º Spin left</td></tr>
                <tr><td><code>put_ball()</code></td><td>Places a ball on the current square</td><td>ğŸ¾ Drop a ball here</td></tr>
                <tr><td><code>take_ball()</code></td><td>Picks up a ball from the current square</td><td>ğŸ¤ Pick it up</td></tr>
                <tr><td><code>turn_around()</code></td><td>Karel turns 180Â° â€” faces opposite direction</td><td>â†© U-turn</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 3 â€” Example 1: Moving -->
        <div class="kn-section kn-ex1">
          <div class="kn-section-header">ğŸ§ª Example 1 â€” Moving Karel Across the Grid</div>
          <div class="kn-section-body">
            <div class="kn-callout">
              <strong>Challenge:</strong> Karel starts at the left side facing right.
              Move Karel <strong>3 squares to the right</strong>.
            </div>
            <div class="kn-world-pair">
              <div class="kn-world-cell">
                <div class="kn-world-label">Before</div>
                <table class="kn-world">
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td class="kn-karel">â–º</td><td></td><td></td><td></td><td></td><td></td></tr>
                </table>
              </div>
              <div class="kn-arrow">â†’</div>
              <div class="kn-world-cell">
                <div class="kn-world-label">After 3 Ã— move()</div>
                <table class="kn-world">
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td class="kn-karel">â–º</td><td></td><td></td></tr>
                </table>
              </div>
            </div>
            <div class="kn-code">
              <div class="kn-code-title">ğŸ–¥ solution_example1.py</div>
<pre class="kn-pre"><span class="kn-cm"># Move Karel 3 squares to the right</span>
<span class="kn-fn">move</span>()   <span class="kn-cm"># step 1 â€” Karel moves to column 1</span>
<span class="kn-fn">move</span>()   <span class="kn-cm"># step 2 â€” Karel moves to column 2</span>
<span class="kn-fn">move</span>()   <span class="kn-cm"># step 3 â€” Karel moves to column 3</span></pre>
            </div>
            <div class="kn-callout kn-tip">
              <strong>Key idea:</strong> Each <code>move()</code> is one instruction.
              The computer runs them <strong>one at a time, top to bottom</strong>.
              This is called <em>sequential execution</em>.
            </div>
            <div class="kn-try">
              <strong>âœï¸ Try it yourself!</strong>
              What code would move Karel <strong>5 squares</strong> to the right?
              Write it out on paper before typing!
            </div>
          </div>
        </div>

        <!-- 4 â€” Example 2: Placing Balls -->
        <div class="kn-section kn-ex2">
          <div class="kn-section-header">ğŸ¾ Example 2 â€” Placing Tennis Balls</div>
          <div class="kn-section-body">
            <div class="kn-callout">
              <strong>Challenge:</strong> Karel starts facing right.
              Place a ball on <strong>each of the first 3 squares</strong> Karel visits.
            </div>
            <div class="kn-world-pair">
              <div class="kn-world-cell">
                <div class="kn-world-label">Before</div>
                <table class="kn-world">
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td class="kn-karel">â–º</td><td></td><td></td><td></td><td></td><td></td></tr>
                </table>
              </div>
              <div class="kn-arrow">â†’</div>
              <div class="kn-world-cell">
                <div class="kn-world-label">After placing 3 balls</div>
                <table class="kn-world">
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td class="kn-ball">â—</td><td class="kn-ball">â—</td><td class="kn-karel">â–º</td><td></td><td></td><td></td></tr>
                </table>
              </div>
            </div>
            <div class="kn-code">
              <div class="kn-code-title">ğŸ–¥ solution_example2.py</div>
<pre class="kn-pre"><span class="kn-cm"># Place a ball, move, repeatâ€¦</span>
<span class="kn-fn">put_ball</span>()  <span class="kn-cm"># drop ball on square 0</span>
<span class="kn-fn">move</span>()      <span class="kn-cm"># step to square 1</span>
<span class="kn-fn">put_ball</span>()  <span class="kn-cm"># drop ball on square 1</span>
<span class="kn-fn">move</span>()      <span class="kn-cm"># step to square 2</span>
<span class="kn-fn">put_ball</span>()  <span class="kn-cm"># drop ball on square 2</span></pre>
            </div>
            <div class="kn-callout kn-fun">
              <strong>Spot the pattern!</strong> We repeated <code>put_ball() â†’ move()</code> three times.
              Whenever you repeat something, there's usually a smarter way â€” called a <em>loop</em>.
              We'll learn loops in the next lesson! ğŸš€
            </div>
            <div class="kn-try">
              <strong>âœï¸ Try it yourself!</strong>
              How would you pick up all 3 balls Karel just placed?
              Hint: use <code>take_ball()</code> and <code>move()</code>.
            </div>
          </div>
        </div>

        <!-- 5 â€” Functions -->
        <div class="kn-section kn-funcs">
          <div class="kn-section-header">âš™ï¸ Creating Your Own Commands â€” Functions</div>
          <div class="kn-section-body">
            <div class="kn-callout">
              <strong>Problem:</strong> Karel can turn <em>left</em> with <code>turn_left()</code>,
              but there is <strong>no</strong> <code>turn_right()</code> command built in!
              How do we make Karel turn right?
            </div>
            <div class="kn-callout kn-tip">
              <strong>Maths trick:</strong> Turning left 3 times = turning right once!
              (3 Ã— 90Â° left = 270Â° left = 90Â° right)
            </div>
            <div class="kn-world-pair">
              <div class="kn-world-cell">
                <div class="kn-world-label">Karel faces North (â–²)</div>
                <table class="kn-world kn-world--sm">
                  <tr><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td class="kn-karel">â–²</td><td></td><td></td><td></td><td></td></tr>
                </table>
              </div>
              <div class="kn-arrow">â†’</div>
              <div class="kn-world-cell">
                <div class="kn-world-label">After turn_right(): faces East (â–º)</div>
                <table class="kn-world kn-world--sm">
                  <tr><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td></td><td></td><td></td><td></td><td></td></tr>
                  <tr><td class="kn-karel">â–º</td><td></td><td></td><td></td><td></td></tr>
                </table>
              </div>
            </div>
            <div class="kn-code">
              <div class="kn-code-title">ğŸ–¥ turn_right_function.py</div>
<pre class="kn-pre"><span class="kn-cm"># Define a new command called turn_right</span>
<span class="kn-kw">def</span> <span class="kn-fn">turn_right</span>():
    <span class="kn-fn">turn_left</span>()  <span class="kn-cm"># 1st left turn  (90Â°)</span>
    <span class="kn-fn">turn_left</span>()  <span class="kn-cm"># 2nd left turn (180Â°)</span>
    <span class="kn-fn">turn_left</span>()  <span class="kn-cm"># 3rd left turn (270Â° = turn right!)</span>

<span class="kn-cm"># â”€â”€ Now use our new command â”€â”€</span>
<span class="kn-fn">move</span>()        <span class="kn-cm"># Karel steps forward</span>
<span class="kn-fn">turn_right</span>()  <span class="kn-cm"># Karel turns right</span>
<span class="kn-fn">move</span>()        <span class="kn-cm"># Karel steps forward again</span></pre>
            </div>
            <div class="kn-callout">
              <strong>Rules for writing a function:</strong>
              <ol style="margin-top:0.4rem; padding-left:1.2rem; line-height:1.8">
                <li>Start with the keyword <code>def</code></li>
                <li>Write the function name (no spaces!)</li>
                <li>Add brackets <code>()</code> and a colon <code>:</code></li>
                <li>Indent the body by <strong>4 spaces</strong> â€” Python is strict about this!</li>
                <li>Call the function anywhere by writing its name followed by <code>()</code></li>
              </ol>
            </div>
          </div>
        </div>

        <!-- 6 â€” Summary -->
        <div class="note-card kn-summary-card">
          <h3>âœ… What You Learned Today</h3>
          <ul>
            <li>Karel is a robot that lives in a grid â€” you control it with Python commands</li>
            <li><code>move()</code> moves Karel one square forward in the direction it faces</li>
            <li><code>turn_left()</code> rotates Karel 90Â° to the left</li>
            <li><code>put_ball()</code> and <code>take_ball()</code> interact with balls</li>
            <li>Python runs instructions <strong>one line at a time</strong>, top to bottom</li>
            <li>You can create <strong>your own commands</strong> using <code>def name():</code></li>
            <li>Indentation (4 spaces) inside a function is <strong>not optional</strong></li>
            <li>Turning left 3 times = turning right once â€” a clever trick!</li>
          </ul>
        </div>

        <!-- Resources -->
        <div class="note-card kn-resources">
          <h3>ğŸ“š Further Resources</h3>
          <div class="kn-res-item">
            <span class="kn-res-label">ğŸ¥ freeCodeCamp â€” Learn Python (Beginner)</span>
            <a class="kn-res-url" href="https://www.youtube.com/watch?v=rfscVS0vtbw" target="_blank">youtube.com/watch?v=rfscVS0vtbw</a>
            <em>Full beginner course â€” 4 hours, 38M+ views</em>
          </div>
          <div class="kn-res-item">
            <span class="kn-res-label">ğŸ¤– Stanford Karel Reader</span>
            <a class="kn-res-url" href="https://compedu.stanford.edu/karel-reader/docs/python/en/intro.html" target="_blank">compedu.stanford.edu/karel-reader</a>
            <em>Official Karel the Robot Python reference</em>
          </div>
          <div class="kn-res-item">
            <span class="kn-res-label">ğŸ“„ Offline Study</span>
            <em>Use the "Download Notes PDF" button below to save these notes.</em>
          </div>
        </div>

        <!-- Mini Tasks -->
        <div class="note-card mini-task">
          <h3>ğŸ“ Mini Tasks (Try These First!)</h3>
          <ol>
            <li>Write a program that moves Karel forward 2 squares.</li>
            <li>Write a program that makes Karel turn right (hint: 3 Ã— turn_left).</li>
            <li>Write a program that places a ball, moves forward, then places another ball.</li>
          </ol>
          <p><strong>Next:</strong> Click <em>Practice Test</em> below and check your score.</p>
        </div>

      </ng-container>
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           END Karel notes
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

      <!-- Generic notes for all other lessons -->
      <ng-container *ngIf="currentLevel.id !== 'python-with-karel'">

      <div class="note-card lesson-goal">
        <h3>ğŸ“˜ Simple Definition</h3>
        <p>{{ getSimpleDefinition() }}</p>
      </div>

      <div class="note-card concept">
        <h3>ğŸŒ Where We Use This in Real Life</h3>
        <ul>
          <li *ngFor="let use of getRealLifeUses()">{{ use }}</li>
        </ul>
      </div>

      <div class="note-card method">
        <h3>ğŸ§  Full Explanation</h3>
        <p>{{ currentLevel.teachingNotes }}</p>
      </div>

      <div class="note-card method" *ngIf="getRegularStrategies().length > 0">
        <h3>ğŸ§­ How to Solve (Step-by-Step)</h3>
        <ol>
          <li *ngFor="let strategy of getRegularStrategies()">{{ strategy }}</li>
        </ol>
      </div>

      <div class="note-card concept">
        <h3>âœï¸ Worked Examples</h3>
        <ul>
          <li *ngFor="let ex of getWorkedExamples()">{{ ex }}</li>
        </ul>
      </div>

      <div class="note-card visuals" *ngIf="module?.id === 'binary-number-system'">
        <h3>ğŸ¨ Binary Helpsheet</h3>
        <p class="helpsheet-tip">Use â—€ â–¶ to move through concept, examples, and summary.</p>

        <div class="helpsheet-controls">
          <button type="button" class="hs-btn" (click)="scrollHelpSheet(helpScroller, 'left')">â—€</button>
          <button type="button" class="hs-btn" (click)="scrollHelpSheet(helpScroller, 'right')">â–¶</button>
        </div>

        <div class="helpsheet-scroller" #helpScroller>
          <article class="hs-card hs-concept">
            <h4>Key Words</h4>
            <p><strong>Bit</strong>: one binary digit (0 or 1)</p>
            <p><strong>Nibble</strong>: 4 bits</p>
            <p><strong>Byte</strong>: 8 bits</p>
            <p><strong>Denary</strong>: normal base-10 numbers</p>
            <p><strong>Hexadecimal</strong>: base-16 (0-9, A-F)</p>
            <p><strong>Place Value</strong>: value of each position in a number</p>
          </article>

          <article class="hs-card hs-concept">
            <h4>Number Conversions</h4>
            <p>Binary place values:</p>
            <div class="bits-row">
              <span>128</span><span>64</span><span>32</span><span>16</span><span>8</span><span>4</span><span>2</span><span>1</span>
            </div>
            <p><strong>Binary to denary:</strong> add columns where bit = 1.</p>
            <p><strong>Denary to binary:</strong> fit place values from left to right.</p>
            <p><strong>Binary to hex:</strong> split into nibbles (4 bits).</p>
            <p><strong>Hex to binary:</strong> convert each hex digit to 4 bits.</p>
          </article>

          <article class="hs-card hs-example">
            <h4>Example 1: Binary â†’ Denary â†’ Hex</h4>
            <p class="code-line">01001101â‚‚</p>
            <p>Denary: 64 + 8 + 4 + 1 = <strong>77</strong></p>
            <p>Hex: 0100 1101 â†’ 4 and 13(D) = <strong>4D</strong></p>
          </article>

          <article class="hs-card hs-example">
            <h4>Example 2: Binary Addition</h4>
            <pre class="mini-diagram">  0100
+ 0101
------
  1001</pre>
            <p>Answer is <strong>1001</strong> (denary 9).</p>
            <p>Rules: 0+0=0, 0+1=1, 1+1=10, 1+1+1=11.</p>
            <p>Remember: 1 + 1 = 10 (write 0, carry 1).</p>
          </article>

          <article class="hs-card hs-example">
            <h4>Denary to Hex Mini Challenge</h4>
            <p>Convert <strong>167</strong> to hex using Ã·16 method:</p>
            <p>167 Ã· 16 = 10 remainder 7</p>
            <p>10 in hex is <strong>A</strong>, so answer is <strong>A7</strong>.</p>
            <p class="code-line">167â‚â‚€ = A7â‚â‚†</p>
          </article>

          <article class="hs-card hs-summary">
            <h4>Summary</h4>
            <ul>
              <li>Use place values to convert binary and denary.</li>
              <li>Group binary into 4 bits for fast hex conversion.</li>
              <li>In binary addition, always work right to left and carry correctly.</li>
            </ul>
          </article>
        </div>
      </div>

      <div class="note-card mistakes">
        <h3>âš ï¸ Common Mistakes to Avoid</h3>
        <ul>
          <li *ngFor="let mistake of currentLevel.commonMistakes">{{ mistake }}</li>
        </ul>
      </div>

      <div class="note-card references" *ngIf="getTaggedNotes().length > 0">
        <h3>ğŸ“š References and Extra Help</h3>
        <ul *ngIf="getReferenceNotes().length > 0">
          <li *ngFor="let note of getReferenceNotes()">{{ note }}</li>
        </ul>
        <ul *ngIf="getOnlineNotes().length > 0">
          <li *ngFor="let note of getOnlineNotes()">{{ note }}</li>
        </ul>
        <div class="mini-notes" *ngIf="getQuickNotes().length > 0">
          <span class="mini-note" *ngFor="let note of getQuickNotes()">{{ note }}</span>
        </div>
      </div>

      <div class="note-card prerequisites">
        <h3>âœ… Summary</h3>
        <ul>
          <li *ngFor="let point of getLessonSummary()">{{ point }}</li>
        </ul>
        <h4>Checkpoint</h4>
        <p><strong>Success criteria:</strong> {{ currentLevel.assessmentCriteria }}</p>
        <h4 *ngIf="currentLevel.prerequisites.length > 0">Prerequisites</h4>
        <ul *ngIf="currentLevel.prerequisites.length > 0">
          <li *ngFor="let prereq of currentLevel.prerequisites">{{ prereq }}</li>
        </ul>
      </div>

      <div class="note-card mini-task">
        <h3>ğŸ“ Mini Task (Try Before Practice)</h3>
        <p>Complete these quickly to check your understanding:</p>
        <ol>
          <li *ngFor="let task of getMiniTask()">{{ task }}</li>
        </ol>
        <p><strong>Next:</strong> Click <em>Practice Test</em> below and check your score.</p>
      </div>

      </ng-container><!-- end generic notes -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-notes-pdf" (click)="downloadNotes()" *ngIf="currentLevel.notesTopicId">
        <span class="btn-icon">ğŸ“„</span>
        <span>Download Notes PDF</span>
      </button>

      <button class="btn-practice" (click)="startAttempt('practice')">
        <span class="btn-icon">âœï¸</span>
        <span>Practice Test (5 Questions)</span>
      </button>

      <button class="btn-challenge" (click)="startAttempt('challenge')">
        <span class="btn-icon">ğŸ¯</span>
        <span>Challenge (10 Questions)</span>
      </button>

      <button class="btn-history" (click)="showHistory()" *ngIf="attemptHistory.length > 0">
        <span class="btn-icon">ğŸ“Š</span>
        <span>View History ({{ attemptHistory.length }} attempts)</span>
      </button>
    </div>

    <!-- Attempt History Preview -->
    <div class="history-preview" *ngIf="attemptHistory.length > 0">
      <h3>Recent Attempts</h3>
      <div class="history-grid">
        <div *ngFor="let attempt of attemptHistory.slice(0, 3)" class="history-card">
          <div class="history-header">
            <span class="attempt-type">{{ attempt.attempt_type === 'practice' ? 'âœï¸ Practice' : 'ğŸ¯ Challenge' }}</span>
            <span class="attempt-date">{{ attempt.created_at | date:'short' }}</span>
          </div>
          <div class="history-score" *ngIf="attempt.score !== null">
            <span class="score">{{ attempt.score }}/{{ attempt.total }}</span>
            <span class="percentage" [class.passed]="attempt.percentage >= 60">{{ attempt.percentage }}%</span>
          </div>
          <div class="history-status" *ngIf="attempt.score === null">
            <span class="pending">Pending submission</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mode Selection View -->
  <div class="mode-select-view" *ngIf="viewState === 'mode-select'">
    <h2>{{ selectedAttemptType === 'practice' ? 'âœï¸ Practice Test - 5 Questions' : 'ğŸ¯ Challenge - 10 Questions' }}</h2>
    <p class="instruction">Choose how you'd like to attempt this:</p>

    <div class="mode-options">
      <div class="mode-card" (click)="selectMode('online')">
        <div class="mode-icon">ğŸ’»</div>
        <h3>Attempt Online</h3>
        <p>Answer questions directly on screen with instant feedback</p>
        <button class="btn-select">Start Now</button>
      </div>

      <div class="mode-card" (click)="selectMode('download')">
        <div class="mode-icon">ğŸ“¥</div>
        <h3>Download to Attempt on Paper</h3>
        <p>Print questions and answer sheet with QR code for submission</p>
        <button class="btn-select">Download PDFs</button>
      </div>
    </div>

    <button class="btn-cancel" (click)="restartLesson()">Cancel</button>
  </div>

  <!-- Online Quiz View -->
  <div class="online-quiz-view" *ngIf="viewState === 'online-quiz' && questions.length > 0">
    <div class="quiz-progress">
      <span>Question {{ currentQuestionIndex + 1 }} of {{ questions.length }}</span>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="((currentQuestionIndex + 1) / questions.length) * 100"></div>
      </div>
    </div>

    <div class="question-card">
      <h3 class="question-text">{{ questions[currentQuestionIndex].question }}</h3>

      <div class="options-list">
        <div
          *ngFor="let opt of ['A', 'B', 'C', 'D']"
          class="option-item"
          [class.selected]="answers['q' + questions[currentQuestionIndex].question_number] === opt"
          (click)="selectAnswer(opt)">
          <span class="option-label">{{ opt }}</span>
          <span class="option-text">{{ questions[currentQuestionIndex].options[opt] }}</span>
        </div>
      </div>
    </div>

    <div class="quiz-navigation">
      <button class="btn-nav" (click)="prevQuestion()" [disabled]="currentQuestionIndex === 0">
        â† Previous
      </button>

      <button class="btn-nav" (click)="nextQuestion()" *ngIf="currentQuestionIndex < questions.length - 1">
        Next â†’
      </button>

      <button class="btn-submit" (click)="submitQuiz()" *ngIf="currentQuestionIndex === questions.length - 1">
        Submit Answers
      </button>
    </div>
  </div>

  <!-- Results View -->
  <div class="results-view" *ngIf="viewState === 'results' && result">
    <div class="results-banner" [class.passed]="result.passed">
      <h2>{{ result.passed ? 'âœ… Well Done!' : 'ğŸ“š Keep Practicing!' }}</h2>
      <div class="score-display">
        <span class="score-large">{{ result.score }}</span>
        <span class="divider">/</span>
        <span class="total">{{ result.total }}</span>
      </div>
      <p class="percentage">{{ result.percentage }}%</p>
    </div>

    <div class="review-section">
      <h3>Review Your Answers</h3>
      <div *ngFor="let item of result.review; let i = index"
           class="review-card"
           [class.review-card--correct]="item.is_correct"
           [class.review-card--wrong]="!item.is_correct">

        <!-- Question header -->
        <div class="rc-header">
          <span class="rc-qnum">{{ item.question_number }}.</span>
          <span class="rc-question">{{ item.question }}</span>
          <span class="rc-badge" [class.rc-badge--correct]="item.is_correct" [class.rc-badge--wrong]="!item.is_correct">
            {{ item.is_correct ? 'âœ“ Correct' : 'âœ— Incorrect' }}
          </span>
        </div>

        <!-- Options row (always visible for wrong answers, compact for correct) -->
        <div class="rc-options-wrap">
          <p class="rc-correct-label" *ngIf="!item.is_correct">The correct answer is:</p>
          <div class="rc-options">
            <div *ngFor="let opt of ['A','B','C','D']"
                 class="rc-opt"
                 [class.rc-opt--chosen-wrong]="!item.is_correct && item.your_answer === opt"
                 [class.rc-opt--correct]="opt === item.correct_option"
                 [class.rc-opt--neutral]="opt !== item.correct_option && item.your_answer !== opt">
              <span class="rc-opt-label">{{ opt }}</span>
              <span class="rc-opt-text">{{ item.options[opt] }}</span>
              <span class="rc-opt-icon" *ngIf="!item.is_correct && item.your_answer === opt">âœ—</span>
              <span class="rc-opt-icon rc-opt-icon--tick" *ngIf="opt === item.correct_option">âœ“</span>
            </div>
          </div>
        </div>

        <!-- Explanation (only for wrong answers) -->
        <div class="rc-explanation" *ngIf="!item.is_correct && item.explanation">
          <h4>Answer Explanation</h4>
          <ul>
            <li *ngFor="let step of getExplanationSteps(item.explanation)">{{ step }}</li>
          </ul>
        </div>

        <!-- Watch Video footer -->
        <div class="rc-footer" *ngIf="!item.is_correct && currentLevel?.videoUrl">
          <a class="rc-watch-video" [href]="currentLevel!.videoUrl.replace('/embed/', '/watch?v=')" target="_blank">
            <span class="rc-watch-icon">â–¶</span>
            <span>Watch Video</span>
          </a>
        </div>

      </div>
    </div>

    <div class="results-actions">
      <button class="btn-restart" (click)="restartLesson()">Back to Lesson</button>
      <button class="btn-next" (click)="completeLevel()">Continue to Next Level</button>
    </div>
  </div>

  <!-- History View -->
  <div class="history-view" *ngIf="viewState === 'history'">
    <h2>ğŸ“Š Attempt History</h2>

    <div class="history-list">
      <div *ngFor="let attempt of attemptHistory" class="history-detail-card">
        <div class="history-detail-header">
          <div>
            <span class="type-badge">{{ attempt.attempt_type === 'practice' ? 'âœï¸ Practice' : 'ğŸ¯ Challenge' }}</span>
            <span class="mode-badge">{{ attempt.mode === 'online' ? 'ğŸ’»' : 'ğŸ“¥' }}</span>
          </div>
          <span class="date">{{ attempt.created_at | date:'medium' }}</span>
        </div>

        <div class="history-detail-body" *ngIf="attempt.score !== null">
          <div class="score-row">
            <span>Score:</span>
            <span class="score-value">{{ attempt.score }}/{{ attempt.total }} ({{ attempt.percentage }}%)</span>
          </div>
          <div class="status-row" [class.passed]="attempt.percentage >= 60">
            {{ attempt.percentage >= 60 ? 'âœ… Passed' : 'ğŸ“š Needs Practice' }}
          </div>
        </div>

        <div class="history-detail-body" *ngIf="attempt.score === null">
          <p class="pending-status">â³ Waiting for submission</p>
          <p class="attempt-id">Attempt ID: {{ attempt.attempt_id }}</p>
        </div>
      </div>
    </div>

    <button class="btn-back-lesson" (click)="restartLesson()">Back to Lesson</button>
  </div>
</section>

<div class="error-state" *ngIf="!currentLevel">
  <h2>Lesson not found</h2>
  <button (click)="goBack()">Return to Learning</button>
</div>
